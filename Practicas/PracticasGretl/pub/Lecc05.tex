% Created 2023-11-02 jue 21:49
% Intended LaTeX compiler: pdflatex
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\usepackage[spanish, ]{babel}
\usepackage[margin=0.5in]{geometry}
\usepackage[svgnames,x11names]{xcolor}
\hypersetup{linktoc = all, colorlinks = true, urlcolor = DodgerBlue4, citecolor = PaleGreen1, linkcolor = SpringGreen4}
\PassOptionsToPackage{hyphens}{url}
\usepackage{nacal}
\usepackage{framed}
\usepackage{listings}
\input{hansl.tex}
\lstnewenvironment{hansl-gretl}
{\lstset{language={hansl},basicstyle={\ttfamily\footnotesize},numbers,rame=single,breaklines=true}}
{}
\newcommand{\hansl}[1]{\lstset{language={hansl},basicstyle={\ttfamily\small}}\lstinline{#1}}
\lstset{backgroundcolor=\color{lightgray!20}, }
\author{Marcos Bujosa}
\date{\today}
\title{Lección 5}
\begin{document}

\maketitle
\tableofcontents

\clearpage

\section{Simulación del ejemplo del precio de las viviendas con tres regresores}
\label{sec:org382e5c7}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda.inp}{BucleSimuladorEjPvivienda.inp}\\[0pt]
\end{tabular}
\end{center}

En este ejercicio con \href{https://gretl.sourceforge.net/es.html}{Gretl} usaremos un bucle para generar muchas
veces datos simulados con los que realizar muchas regresiones MCO de
un mismo modelo y así observar el comportamiento del estimador MCO.

\subsection{Tareas}
\label{sec:org98f3006}

\begin{description}
\item[{Fijamos el tamaño muestral}] Simulamos series de datos de 500
observaciones. Indicamos la opción \texttt{-{}-preserve} para que Gretl
mantenga en memoria el escalar que fija el tamaño muestral \texttt{TM}
\end{description}
\begin{verbatim}
scalar TM  = 500
nulldata --preserve TM
\end{verbatim}

\begin{description}
\item[{Simulamos S y D}] Generamos dos variables que serán los regresores
no constantes: \texttt{S} con distribución uniforme (35, 120); \texttt{D} con
distribución Chi cuadrado con 5 grados de libertad que vamos a
multiplicar por 3
\end{description}
\begin{verbatim}
series S = randgen(U, 35, 120)
series D = randgen(X, 5) * 3
\end{verbatim}

\begin{description}
\item[{Parte sistemática}] La parte \emph{sistemática} del modelo es
\(\Vect[s]{y} = 100(\Vect{1}) + 3\Vect{s} - 130\Vect{D}\)
\end{description}
\begin{verbatim}
series YS = 100 + 3*S - 130*D
\end{verbatim}

\begin{description}
\item[{Esperanza y desviación típica de U}] En cada iteración generaremos
una nueva perturbación \texttt{U} con media cero \texttt{mu=0} y desviación típica
\texttt{sigma=100} (por tanto la longitud o norma de \texttt{U} será 100 en cada
iteración)
\end{description}
\begin{verbatim}
scalar mu    = 0
scalar sigma = 100
\end{verbatim}

\begin{description}
\item[{Generación del vector de perturbaciones U}] 
\end{description}
\begin{verbatim}
series U = randgen(N, mu ,sigma )
\end{verbatim}

\begin{description}
\item[{Comprobación de si U es ortogonal a los regresores S y D}] Dos
vectores son perpendiculares si la media del producto Hadamard
(componente a componente) entre ellos es nula. Si uno de los
vectores tiene media nula, entonces ambos vectores son ortogonales
si su correlación es nula. Vamos a calcular estos estadísticos
\end{description}
\begin{verbatim}
scalar mU  = mean(U)
scalar mUS = mean(U*S)
scalar mUD = mean(U*D)
scalar cUS = corr(U,S)
scalar cUD = corr(U,D)
\end{verbatim}

\begin{description}
\item[{Parámetros beta estimados}] En cada iteración guardamos los betas
estimados
\end{description}
\begin{verbatim}
scalar b1 = $coeff(const)
scalar b2 = $coeff(S)
scalar b3 = $coeff(D)
\end{verbatim}

\begin{description}
\item[{Visualización de resultados y guardado en disco}] Para estudiar los
resultados, mostramos los estadísticos calculados y los guardamos en
el fichero \texttt{coef.gdt}.
\end{description}
\begin{verbatim}
print mU mUS mUD cUS cUD b1 b2 b3
store "@workdir/coef.gdt" mU mUS mUD cUS cUD b1 b2 b3
\end{verbatim}

\begin{description}
\item[{Análisis gráfico de los resultados}] Una vez finalizado el bucle,
pedimos a Gretl que abra el fichero de resultados guardado (se
abrirá nueva sesión) y generamos unos diagramas donde vamos a ver
cómo perturbaciones más alejadas de la perpendicularidad con los
regresores afectan más a las estimaciones del parámetro beta
asociado al regresor correspondiente.
\end{description}
\begin{verbatim}
open "@workdir/coef.gdt"
MediaU_b1  <- gnuplot b1 mU  --output="display"
CorrUS_b2  <- gnuplot b2 cUS --output="display"
CorrUD_b3  <- gnuplot b3 cUD --output="display"
CorrUD_b2  <- gnuplot b2 cUD --output="display"
CorrUS_b3  <- gnuplot b3 cUS --output="display"
\end{verbatim}

\subsection{Estructura del guión}
\label{sec:org15e73c1}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Simulamos S y D>>
<<Parte sistemática>>
<<Esperanza y desviación típica de U>>
loop 5000 --progressive --quiet
     <<Generación del vector de perturbaciones U>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda.inp}
\clearpage


\section{Simulación del ejemplo del precio de las viviendas con tres regresores que cambian}
\label{sec:org7fef4a2}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda2.inp}{BucleSimuladorEjPvivienda2.inp}\\[0pt]
\end{tabular}
\end{center}

En este ejercicio con \href{https://gretl.sourceforge.net/es.html}{Gretl} repetimos lo anterior, pero en cada
iteración también cambian los regresores.

\subsection{Estructura del guión}
\label{sec:org0f6d24a}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Esperanza y desviación típica de U>>
loop 5000 --progressive --quiet
     <<Simulamos S y D>>
     <<Parte sistemática>>
     <<Generación del vector de perturbaciones U>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda2.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda2.inp}
\clearpage


\section{Simulación del ejemplo del precio de las viviendas con tres regresores que cambian pero U se mantiene}
\label{sec:org2edd499}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda3.inp}{BucleSimuladorEjPvivienda3.inp}\\[0pt]
\end{tabular}
\end{center}

En este ejercicio con \href{https://gretl.sourceforge.net/es.html}{Gretl} repetimos lo anterior, pero en cada
iteración solo cambian los regresores.

\subsection{Estructura del guión}
\label{sec:org8f44412}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Esperanza y desviación típica de U>>
<<Generación del vector de perturbaciones U>>
loop 5000 --progressive --quiet
     <<Simulamos S y D>>
     <<Parte sistemática>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda3.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda3.inp}
\clearpage


\section{Simulación del ejemplo del precio de las viviendas con tres regresores ortogonales}
\label{sec:org9428727}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda4.inp}{BucleSimuladorEjPvivienda4.inp}\\[0pt]
\end{tabular}
\end{center}

En este ejercicio con \href{https://gretl.sourceforge.net/es.html}{Gretl} repetimos lo anterior, pero en cada
iteración cambia la perturbación y cambian los regresores, pero los
regresores son ortogonales entre si.

\begin{description}
\item[{Simulamos S y D ortogonales}] Generamos dos variables que serán los
regresores no constantes: \texttt{S} con distribución uniforme (35, 120);
\texttt{D} con distribución Chi cuadrado con 5 grados de libertad que vamos
a multiplicar por 3; pero luego ortogonalizamos los regresores.
\end{description}
\begin{verbatim}
series S0 = randgen(U, 35, 120)
series D0 = randgen(X, 5) * 3
ols S0 0
series S = $uhat
ols D0 0 S
series D = $uhat
\end{verbatim}

\subsection{Estructura del guión}
\label{sec:org50228fe}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Esperanza y desviación típica de U>>
loop 5000 --progressive --quiet
     <<Simulamos S y D ortogonales>>
     <<Parte sistemática>>
     <<Generación del vector de perturbaciones U>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\clearpage
\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda4.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda4.inp}
\clearpage


\section{Simulación del ejemplo del precio de las viviendas forzando a que la muestra de U cumpla los supuestos}
\label{sec:org4622744}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda5.inp}{BucleSimuladorEjPvivienda5.inp}\\[0pt]
\end{tabular}
\end{center}

En este ejercicio con \href{https://gretl.sourceforge.net/es.html}{Gretl} repetimos lo anterior, pero en cada
iteración también cambian los regresores.

\begin{description}
\item[{Generación del vector de perturbaciones U forzando que la muestra cumpla los supuestos}] 
\end{description}
\begin{verbatim}
series U  = randgen(N, 0, 1)
series U  = U - mean(U)
series U  = U / sqrt( var(U)*(TM-1)/TM )
series U  = mu + sigma * U
ols U 0 S D
series U  = $uhat
\end{verbatim}

\subsection{Estructura del guión}
\label{sec:org52b6740}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Esperanza y desviación típica de U>>
loop 5000 --progressive --quiet
     <<Simulamos S y D>>
     <<Parte sistemática>>
     <<Generación del vector de perturbaciones U forzando que la muestra cumpla los supuestos>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\clearpage
\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda5.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda5.inp}
\clearpage


\section{Efectos del incumplimiento de algunos supuestos (perturbaciones sin esperanza nula)}
\label{sec:orgcccfa9b}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda6.inp}{BucleSimuladorEjPvivienda6.inp}\\[0pt]
\end{tabular}
\end{center}

Vamos a ver cómo afecta a las estimaciones simular modelos que
incumplen algunos de los supuestos. Por ejemplo, ¿qué pasa si las
perturbaciones tienen esperanza no nula?

\subsection{Estructura del guión}
\label{sec:org2309048}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
scalar mu    = 1000
scalar sigma = 100
loop 5000 --progressive --quiet
     <<Simulamos S y D>>
     <<Parte sistemática>>
     <<Generación del vector de perturbaciones U>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda6.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda6.inp}
\clearpage



\section{Efectos del incumplimiento de algunos supuestos (perturbaciones no ortogonales a S)}
\label{sec:org3c49044}

\begin{center}
\begin{tabular}{ll}
Guión: & \href{https://github.com/mbujosab/Ectr/tree/master/Practicas/Gretl/scripts/BucleSimuladorEjPvivienda7.inp}{BucleSimuladorEjPvivienda7.inp}\\[0pt]
\end{tabular}
\end{center}

Vamos a ver cómo afecta a las estimaciones simular modelos que
incumplen algunos de los supuestos. Por ejemplo, ¿qué pasa si las
perturbaciones no son ortogonales a uno o más regresores no
constantes?

\begin{description}
\item[{Definición de la matriz para generar correlación entre U y S}] Definimos
la matriz con la que generar perturbaciones correladas con los
regresores (\emph{No recuerdo de donde saqué este modo de hacerlo}).
\end{description}
\begin{verbatim}
matrix C  = {1 ,   0,   0; 0 ,  1,   0; -10,  0,  1}
#matrix C  = {1 ,   0,   0; 0 ,  1,   0;  0, 100,  1}
\end{verbatim}


\begin{description}
\item[{Generación del vector de perturbaciones U correladas con los regresores}] (\emph{No
recuerdo de donde saqué este modo de hacerlo}).
\end{description}
\begin{verbatim}
series U0 = randgen(N, 0, 1)
matrix Z = {S,D,U0}
Z *= C'               #  note: use the transpose '
series U  = Z[,3]     # generamos las perturbaciones
\end{verbatim}


\subsection{Estructura del guión}
\label{sec:org64c0fcc}

\begin{verbatim}
<<Fijamos el tamaño muestral>>
<<Esperanza y desviación típica de U>>
<<Definición de la matriz para generar correlación entre U y S>>
loop 5000 --progressive --quiet
     <<Simulamos S y D>>
     <<Parte sistemática>>
     <<Generación del vector de perturbaciones U correladas con los regresores>>
     series Y  = YS + U
     <<Comprobación de si U es ortogonal a los regresores S y D>>
     ols Y 0 S D
     <<Parámetros beta estimados>>
     <<Visualización de resultados y guardado en disco>>
endloop
<<Análisis gráfico de los resultados>>
\end{verbatim}

\clearpage
\noindent
\textbf{Código completo de la práctica} \texttt{BucleSimuladorEjPvivienda7.inp}
\vspace{10pt}
\lstinputlisting{scripts/BucleSimuladorEjPvivienda7.inp}
\clearpage
\end{document}